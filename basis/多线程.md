# 1 åŸºç¡€

æ“ä½œç³»ç»ŸåŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡å®é™…ä¸Šå°±æ˜¯è®©CPUå¯¹å¤šä¸ªä»»åŠ¡è½®æµäº¤æ›¿æ‰§è¡Œ

### è¿›ç¨‹

- åœ¨è®¡ç®—æœºä¸­ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªä»»åŠ¡ç§°ä¸ºä¸€ä¸ªè¿›ç¨‹ï¼Œæµè§ˆå™¨å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè§†é¢‘æ’­æ”¾å™¨æ˜¯å¦ä¸€ä¸ªè¿›ç¨‹
- æŸäº›è¿›ç¨‹å†…éƒ¨è¿˜éœ€è¦åŒæ—¶æ‰§è¡Œå¤šä¸ªå­ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨Wordæ—¶ï¼ŒWordå¯ä»¥è®©æˆ‘ä»¬ä¸€è¾¹æ‰“å­—ï¼Œä¸€è¾¹è¿›è¡Œæ‹¼å†™æ£€æŸ¥ï¼ŒåŒæ—¶è¿˜å¯ä»¥åœ¨åå°è¿›è¡Œæ‰“å°ï¼Œæˆ‘ä»¬æŠŠå­ä»»åŠ¡ç§°ä¸º**çº¿ç¨‹**
- ä¸€ä¸ªè¿›ç¨‹(`Process`)å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹(`Thread`)ï¼Œä½†è‡³å°‘ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼›åŒä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæ—¢å¯ä»¥æœ‰å¤šä¸ªè¿›ç¨‹ï¼Œä¹Ÿå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹
- æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°ä»»åŠ¡å•ä½æ˜¯çº¿ç¨‹ï¼Œè€Œä¸æ˜¯è¿›ç¨‹

### å¤šä»»åŠ¡

å®ç°å¤šä»»åŠ¡çš„æ–¹æ³•ï¼š

1. å¤šè¿›ç¨‹æ¨¡å¼ï¼ˆæ¯ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Process   â”‚ â”‚Process   â”‚ â”‚Process   â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚ Thread â”‚â”‚ â”‚â”‚ Thread â”‚â”‚ â”‚â”‚ Thread â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç¼ºç‚¹ï¼š

- åˆ›å»ºè¿›ç¨‹æ¯”åˆ›å»ºçº¿ç¨‹**å¼€é”€å¤§**ï¼Œå°¤å…¶æ˜¯åœ¨Windowsç³»ç»Ÿä¸Š
- è¿›ç¨‹é—´é€šä¿¡æ¯”çº¿ç¨‹é—´**é€šä¿¡**è¦**æ…¢**ï¼Œå› ä¸ºçº¿ç¨‹é—´é€šä¿¡å°±æ˜¯è¯»å†™åŒä¸€ä¸ªå˜é‡ï¼Œé€Ÿåº¦å¾ˆå¿«

ä¼˜ç‚¹ï¼š

- å¤šè¿›ç¨‹**ç¨³å®šæ€§**æ¯”å¤šçº¿ç¨‹**é«˜**ï¼Œå› ä¸ºåœ¨å¤šè¿›ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¿›ç¨‹å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹ï¼Œè€Œåœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹å´©æºƒä¼šç›´æ¥å¯¼è‡´æ•´ä¸ªè¿›ç¨‹å´©æºƒ



2. å¤šçº¿ç¨‹æ¨¡å¼ï¼ˆä¸€ä¸ªè¿›ç¨‹æœ‰å¤šä¸ªçº¿ç¨‹ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Process             â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚ Thread â”‚â”‚ Thread â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚ Thread â”‚â”‚ Thread â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä¸€ä¸ªJavaç¨‹åºå®é™…ä¸Šæ˜¯ä¸€ä¸ªJVMè¿›ç¨‹ï¼ŒJVMè¿›ç¨‹ç”¨ä¸€ä¸ªä¸»çº¿ç¨‹æ¥æ‰§è¡Œ`main()`æ–¹æ³•ï¼Œåœ¨`main()`æ–¹æ³•å†…éƒ¨ï¼Œæˆ‘ä»¬åˆå¯ä»¥å¯åŠ¨å¤šä¸ªçº¿ç¨‹

æ­¤å¤–ï¼ŒJVMè¿˜æœ‰è´Ÿè´£åƒåœ¾å›æ”¶çš„å…¶ä»–å·¥ä½œçº¿ç¨‹ç­‰

ç‰¹ç‚¹ï¼š

- å¤šçº¿ç¨‹æ¨¡å‹æ˜¯Javaç¨‹åºæœ€åŸºæœ¬çš„å¹¶å‘æ¨¡å‹
- åç»­è¯»å†™ç½‘ç»œã€æ•°æ®åº“ã€Webå¼€å‘ç­‰éƒ½ä¾èµ–Javaå¤šçº¿ç¨‹æ¨¡å‹



3. å¤šè¿›ç¨‹ï¼‹å¤šçº¿ç¨‹æ¨¡å¼ï¼ˆå¤æ‚åº¦æœ€é«˜ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Process   â”‚â”‚Process   â”‚â”‚Process   â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚ Thread â”‚â”‚â”‚â”‚ Thread â”‚â”‚â”‚â”‚ Thread â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚ Thread â”‚â”‚â”‚â”‚ Thread â”‚â”‚â”‚â”‚ Thread â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



---



# 2 åˆ›å»ºæ–°çº¿ç¨‹

å®ä¾‹åŒ–ä¸€ä¸ª`Thread`å®ä¾‹ï¼Œç„¶åè°ƒç”¨å®ƒçš„`start()`æ–¹æ³•

```java
// å¤šçº¿ç¨‹
public class Main {
    public static void main(String[] args) {
        Thread t = new Thread();
        t.start(); // å¯åŠ¨æ–°çº¿ç¨‹
        // start()æ–¹æ³•ä¼šåœ¨å†…éƒ¨è‡ªåŠ¨è°ƒç”¨å®ä¾‹çš„run()æ–¹æ³•
        // ç›´æ¥è°ƒç”¨run()æ–¹æ³•æ˜¯æ— æ•ˆçš„ï¼Œå½“å‰çº¿ç¨‹å¹¶æ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Œä¹Ÿæ²¡æœ‰æ–°çº¿ç¨‹è¢«å¯åŠ¨
        // t.run();
    }
}
```



æ–°çº¿ç¨‹æ‰§è¡ŒæŒ‡å®šçš„ä»£ç ï¼š

1. ä»`Thread`æ´¾ç”Ÿä¸€ä¸ªè‡ªå®šä¹‰ç±»ï¼Œç„¶åè¦†å†™`run()`æ–¹æ³•

```java
public class Main {
    public static void main(String[] args) {
        Thread t = new MyThread();
        t.start(); // å¯åŠ¨æ–°çº¿ç¨‹
    }
}

class MyThread extends Thread {
    @Override
    public void run() {
        System.out.println("start new thread!");
    }
}
```

2. åˆ›å»º`Thread`å®ä¾‹æ—¶ï¼Œä¼ å…¥ä¸€ä¸ª`Runnable`å®ä¾‹

```java
public class Main {
    public static void main(String[] args) {
        Thread t = new Thread(new MyRunnable());
        t.start(); // å¯åŠ¨æ–°çº¿ç¨‹
    }
}

class MyRunnable implements Runnable {
    @Override
    public void run() {
        System.out.println("start new thread!");
    }
}
/* --------------Lambda ç®€åŒ–-------------- */
public class Main {
    public static void main(String[] args) {
        Thread t = new Thread(() -> {
            System.out.println("start new thread!");
        });
        t.start(); // å¯åŠ¨æ–°çº¿ç¨‹
    }
}
```



`Thread.sleep()`å¼ºè¿«å½“å‰çº¿ç¨‹æš‚åœä¸€æ®µæ—¶é—´ï¼šä¼ å…¥çš„å‚æ•°æ˜¯æ¯«ç§’ï¼Œè°ƒæ•´æš‚åœæ—¶é—´çš„å¤§å°

```java
try {
    Thread.sleep(20);
} catch (InterruptedException e) {}
System.out.println("main end...");
```



è®¾ç½®çº¿ç¨‹çš„ä¼˜å…ˆçº§

```java
Thread.setPriority(int n) // 1~10, é»˜è®¤å€¼5
```

- JVMè‡ªåŠ¨æŠŠ1ï¼ˆä½ï¼‰~10ï¼ˆé«˜ï¼‰çš„ä¼˜å…ˆçº§æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿå®é™…ä¼˜å…ˆçº§ä¸Š

- ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹è¢«æ“ä½œç³»ç»Ÿè°ƒåº¦çš„ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œæ“ä½œç³»ç»Ÿå¯¹é«˜ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½è°ƒåº¦æ›´é¢‘ç¹

- å†³ä¸èƒ½é€šè¿‡è®¾ç½®ä¼˜å…ˆçº§æ¥ç¡®ä¿é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¸€å®šä¼šå…ˆæ‰§è¡Œ â€¼ï¸



---



# 3 çº¿ç¨‹çš„çŠ¶æ€

Javaç¨‹åºä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åªèƒ½è°ƒç”¨ä¸€æ¬¡`start()`æ–¹æ³•å¯åŠ¨æ–°çº¿ç¨‹ï¼Œå¹¶åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œ`run()`æ–¹æ³•

`run()`æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œçº¿ç¨‹å°±ç»“æŸäº†



Javaçº¿ç¨‹çš„çŠ¶æ€æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- Newï¼šæ–°åˆ›å»ºçš„çº¿ç¨‹ï¼Œå°šæœªæ‰§è¡Œ
- Runnableï¼šè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œæ­£åœ¨æ‰§è¡Œ`run()`æ–¹æ³•çš„Javaä»£ç 
- Blockedï¼šè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå› ä¸ºæŸäº›æ“ä½œè¢«é˜»å¡è€ŒæŒ‚èµ·
- Waitingï¼šè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå› ä¸ºæŸäº›æ“ä½œåœ¨ç­‰å¾…ä¸­
- Timed Waitingï¼šè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå› ä¸ºæ‰§è¡Œ`sleep()`æ–¹æ³•æ­£åœ¨è®¡æ—¶ç­‰å¾…
  - çº¿ç¨‹å¯åŠ¨åï¼Œå®ƒå¯ä»¥åœ¨`Runnable`ã€`Blocked`ã€`Waiting`å’Œ`Timed Waiting`è¿™å‡ ä¸ªçŠ¶æ€ä¹‹é—´åˆ‡æ¢
- Terminatedï¼šçº¿ç¨‹å·²ç»ˆæ­¢ï¼Œå› ä¸º`run()`æ–¹æ³•æ‰§è¡Œå®Œæ¯•
  - æ­£å¸¸ç»ˆæ­¢ï¼š`run()`æ–¹æ³•æ‰§è¡Œåˆ°`return`è¯­å¥è¿”å›
  - æ„å¤–ç»ˆæ­¢ï¼š`run()`æ–¹æ³•å› ä¸ºæœªæ•è·çš„å¼‚å¸¸å¯¼è‡´çº¿ç¨‹ç»ˆæ­¢
  - å¼ºåˆ¶ç»ˆæ­¢ï¼šå¯¹æŸä¸ªçº¿ç¨‹çš„`Thread`å®ä¾‹è°ƒç”¨`stop()`æ–¹æ³•



ä¸€ä¸ªçº¿ç¨‹è¿˜å¯ä»¥ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹ç›´åˆ°å…¶è¿è¡Œç»“æŸ

```java
public class Main {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new Thread(() -> {
            System.out.println("hello");
        });
        System.out.println("start");
        t.start(); // å¯åŠ¨tçº¿ç¨‹
        // mainçº¿ç¨‹å¯¹çº¿ç¨‹å¯¹è±¡tè°ƒç”¨join()æ–¹æ³•
        t.join(); // æ­¤å¤„mainçº¿ç¨‹ä¼šç­‰å¾…tç»“æŸ,ç„¶åæ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œè‡ªèº«çº¿ç¨‹
        // å¦‚æœtçº¿ç¨‹å·²ç»ç»“æŸï¼Œå¯¹å®ä¾‹tè°ƒç”¨join()ä¼šç«‹åˆ»è¿”å›
        // join(long)çš„é‡è½½æ–¹æ³•ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡ç­‰å¾…æ—¶é—´åå°±ä¸å†ç»§ç»­ç­‰å¾…
        System.out.println("end");
    }
}
```



---



# 4 ä¸­æ–­çº¿ç¨‹

1. åœ¨å…¶ä»–çº¿ç¨‹ä¸­å¯¹ç›®æ ‡çº¿ç¨‹è°ƒç”¨`interrupt()`æ–¹æ³•ï¼Œç›®æ ‡çº¿ç¨‹éœ€è¦åå¤æ£€æµ‹è‡ªèº«çŠ¶æ€æ˜¯å¦æ˜¯interruptedçŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œå°±ç«‹åˆ»ç»“æŸè¿è¡Œ

```java
public class Main {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new MyThread();
        t.start();
        Thread.sleep(1); // æš‚åœ1æ¯«ç§’
        t.interrupt(); // ä¸­æ–­tçº¿ç¨‹
        // interrupt()æ–¹æ³•ä»…ä»…å‘tçº¿ç¨‹å‘å‡ºäº†â€œä¸­æ–­è¯·æ±‚â€ï¼Œè‡³äºtçº¿ç¨‹æ˜¯å¦èƒ½ç«‹åˆ»å“åº”ï¼Œè¦çœ‹å…·ä½“ä»£ç 
        t.join(); // ç­‰å¾…tçº¿ç¨‹ç»“æŸ
        // t.join()ä¼šè®©mainçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€
        // å¯¹äºå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹è°ƒç”¨interrupt()ï¼Œjoin()æ–¹æ³•ä¼šç«‹åˆ»æŠ›å‡ºInterruptedException
        System.out.println("end");
    }
}

class MyThread extends Thread {
    public void run() {
        int n = 0;
        while (! isInterrupted()) {
            n ++;
            System.out.println(n + " hello!");
        }
    }
}
```

2. è®¾ç½®æ ‡å¿—ä½ï¼Œé€šå¸¸ç”¨ä¸€ä¸ª`running`æ ‡å¿—ä½æ¥æ ‡è¯†çº¿ç¨‹æ˜¯å¦åº”è¯¥ç»§ç»­è¿è¡Œï¼Œåœ¨å¤–éƒ¨çº¿ç¨‹ä¸­ï¼Œé€šè¿‡æŠŠ`HelloThread.running`ç½®ä¸º`false`ï¼Œå°±å¯ä»¥è®©çº¿ç¨‹ç»“æŸ

```java
public class Main {
    public static void main(String[] args)  throws InterruptedException {
        HelloThread t = new HelloThread();
        t.start();
        Thread.sleep(1);
        t.running = false; // æ ‡å¿—ä½ç½®ä¸ºfalse
    }
}

class HelloThread extends Thread {
    // ä½¿ç”¨ volatile å…³é”®å­—æ ‡è®°çº¿ç¨‹é—´å…±äº«çš„å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½èƒ½è¯»å–åˆ°æ›´æ–°åçš„å˜é‡å€¼
    /*
    * JVMï¼Œå˜é‡çš„å€¼ä¿å­˜åœ¨ä¸»å†…å­˜
    * çº¿ç¨‹è®¿é—®å˜é‡æ—¶ï¼Œå®ƒä¼šå…ˆè·å–ä¸€ä¸ªå‰¯æœ¬ï¼Œå¹¶ä¿å­˜åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­
    * å¦‚æœçº¿ç¨‹ä¿®æ”¹äº†å˜é‡çš„å€¼ï¼Œè™šæ‹Ÿæœºä¼šåœ¨æŸä¸ªæ—¶åˆ»æŠŠä¿®æ”¹åçš„å€¼å›å†™åˆ°ä¸»å†…å­˜
    * è¿™æ ·ä¼šå¯¼è‡´é”™è¯¯
    * 
    * volatileå…³é”®å­—ï¼š
    * æ¯æ¬¡è®¿é—®å˜é‡æ—¶ï¼Œæ€»æ˜¯è·å–ä¸»å†…å­˜çš„æœ€æ–°å€¼
    * æ¯æ¬¡ä¿®æ”¹å˜é‡åï¼Œç«‹åˆ»å›å†™åˆ°ä¸»å†…å­˜
    */
    public volatile boolean running = true;
    public void run() {
        int n = 0;
        while (running) {
            n ++;
            System.out.println(n + " hello!");
        }
        System.out.println("end!");
    }
}
```



---



# 5 å®ˆæŠ¤çº¿ç¨‹

Javaç¨‹åºå…¥å£å°±æ˜¯ç”±JVMå¯åŠ¨`main`çº¿ç¨‹ï¼Œ`main`çº¿ç¨‹åˆå¯ä»¥å¯åŠ¨å…¶ä»–çº¿ç¨‹

å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰æ˜¯æŒ‡ä¸ºå…¶ä»–çº¿ç¨‹æœåŠ¡çš„çº¿ç¨‹ï¼ˆç›®çš„å°±æ˜¯æ— é™å¾ªç¯ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå®šæ—¶è§¦å‘ä»»åŠ¡çš„çº¿ç¨‹ï¼‰

åœ¨JVMä¸­ï¼Œæ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œæ— è®ºæœ‰æ²¡æœ‰å®ˆæŠ¤çº¿ç¨‹ï¼Œè™šæ‹Ÿæœºéƒ½ä¼šè‡ªåŠ¨é€€å‡ºã€‚

åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹ï¼šåœ¨è°ƒç”¨`start()`æ–¹æ³•å‰ï¼Œè°ƒç”¨**`setDaemon(true)`**æŠŠè¯¥çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹



å®ˆæŠ¤çº¿ç¨‹ä¸èƒ½æŒæœ‰ä»»ä½•éœ€è¦å…³é—­çš„èµ„æºï¼Œä¾‹å¦‚æ‰“å¼€æ–‡ä»¶ç­‰ï¼Œå› ä¸ºè™šæ‹Ÿæœºé€€å‡ºæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹æ²¡æœ‰ä»»ä½•æœºä¼šæ¥å…³é—­æ–‡ä»¶ï¼Œè¿™ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±



---



# 6 çº¿ç¨‹åŒæ­¥

AddThreadå’ŒDecThreadåŒæ—¶æ“ä½œCounter.countï¼Œå‰è€… +1 10000æ¬¡ï¼Œåè€…-1 10000æ¬¡ï¼Œæœ€åæœŸæœ›å¾—åˆ°0

```java
// å¤šçº¿ç¨‹
public class Main {
    public static void main(String[] args) throws Exception {
        var add = new AddThread();
        var dec = new DecThread();
        add.start();
        dec.start();
        add.join();
        dec.join();
        System.out.println(Counter.count);
    }
}

class Counter {
    public static int count = 0;
}

class AddThread extends Thread {
    public void run() {
        for (int i=0; i<10000; i++) { Counter.count += 1; }
    }
}

class DecThread extends Thread {
    public void run() {
        for (int i=0; i<10000; i++) { Counter.count -= 1; }
    }
}
```

ç»“æœå¤§æ¦‚ä¸æ˜¯0ï¼Œå› ä¸ºå¯¹Counter.countçš„åŠ å‡ä¸æ˜¯**åŸå­æ“ä½œ**ï¼ŒåŒ…æ‹¬ILOAD, IADD, ISTOREï¼Œå¯èƒ½è¢«ä¸­æ–­



ä½¿ç”¨**`synchronized`**å…³é”®å­—å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡ŒåŠ é”

```java
...
class Counter {
    public static final Object lock = new Object();
    public static int count = 0;
}
...
synchronized(Counter.lock) {	// è·å–é”
    // ç”¨`Counter.lock`å®ä¾‹ä½œä¸ºé”ï¼Œçº¿ç¨‹åœ¨æ‰§è¡Œå„è‡ªçš„`synchronized(Counter.lock) { ... }`ä»£ç å—æ—¶ï¼Œå¿…é¡»å…ˆè·å¾—é”ï¼Œæ‰èƒ½è¿›å…¥ä»£ç å—è¿›è¡Œ
    Counter.count += 1;
    // åœ¨ä½¿ç”¨synchronizedçš„æ—¶å€™ï¼Œä¸å¿…æ‹…å¿ƒæŠ›å‡ºå¼‚å¸¸ã€‚å› ä¸ºæ— è®ºæ˜¯å¦æœ‰å¼‚å¸¸ï¼Œéƒ½ä¼šåœ¨synchronizedç»“æŸå¤„æ­£ç¡®é‡Šæ”¾é”
}    // æ‰§è¡Œç»“æŸåè‡ªåŠ¨é‡Šæ”¾é”
...
```

è¿™æ ·ä¸€æ¥ï¼Œå¯¹`Counter.count`å˜é‡è¿›è¡Œè¯»å†™å°±ä¸å¯èƒ½åŒæ—¶è¿›è¡Œï¼Œä¸Šè¿°ä»£ç æ— è®ºè¿è¡Œå¤šå°‘æ¬¡ï¼Œæœ€ç»ˆç»“æœéƒ½æ˜¯0ã€‚

ç¼ºç‚¹ï¼šå¸¦æ¥äº†**æ€§èƒ½ä¸‹é™**



ä¸éœ€è¦synchronizedçš„æ“ä½œï¼š

- JVMè§„èŒƒå®šä¹‰äº†å‡ ç§åŸå­æ“ä½œï¼š

  - åŸºæœ¬ç±»å‹ï¼ˆ`long`å’Œ`double`é™¤å¤–ï¼‰èµ‹å€¼ï¼Œä¾‹å¦‚ï¼š`int n = m`

  - å¼•ç”¨ç±»å‹èµ‹å€¼ï¼Œä¾‹å¦‚ï¼š`List<String> list = anotherList`

- å•æ¡åŸå­æ“ä½œçš„è¯­å¥ä¸éœ€è¦åŒæ­¥ï¼Œä¾‹å¦‚å•è¡Œèµ‹å€¼
- **ä¸å¯å˜å¯¹è±¡æ— éœ€åŒæ­¥**



### åŒæ­¥æ–¹æ³•

è®©çº¿ç¨‹è‡ªå·±é€‰æ‹©é”å¯¹è±¡å¾€å¾€ä¼šä½¿å¾—ä»£ç é€»è¾‘æ··ä¹±ï¼Œä¹Ÿä¸åˆ©äºå°è£…ï¼š`synchronized(Counter.lock){...}`

äºæ˜¯æŠŠ`synchronized`é€»è¾‘å°è£…èµ·æ¥

```java
public class Counter {
    private int count = 0;

    public void add(int n) {
        synchronized(this) {
            count += n;
        }
    }
	// é”ä½thiså®ä¾‹ å¯ä»¥å†™ä½œ
    // ç”¨synchronizedä¿®é¥°çš„æ–¹æ³•å°±æ˜¯åŒæ­¥æ–¹æ³• è¡¨ç¤ºæ•´ä¸ªæ–¹æ³•éƒ½å¿…é¡»ç”¨thiså®ä¾‹åŠ é”
    // å¦‚æœä½¿ç”¨synchronizedä¿®é¥°staticæ–¹æ³• é”ä½çš„æ˜¯è¯¥ç±»çš„(JVMè‡ªåŠ¨åˆ›å»ºçš„)Classå®ä¾‹
    public synchronized void dec(int n) {
        count -= n;
    }

    // è¯»ä¸€ä¸ªintå˜é‡ä¸éœ€è¦åŒæ­¥ å¦‚æœæ¶‰åŠå¤šä¸ªå°±éœ€è¦åŒæ­¥äº†
    public int get() {
        return count;
    }
}
```



### æ­»é”

Javaçš„çº¿ç¨‹é”æ˜¯**å¯é‡å…¥é”**ï¼šèƒ½è¢«åŒä¸€ä¸ªçº¿ç¨‹åå¤è·å–çš„é”

è·å–é”çš„æ—¶å€™ï¼Œä¸ä½†è¦åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡è·å–ï¼Œè¿˜è¦è®°å½•è¿™æ˜¯ç¬¬å‡ æ¬¡è·å–

æ¯è·å–ä¸€æ¬¡é”ï¼Œè®°å½•+1ï¼Œæ¯é€€å‡º`synchronized`å—ï¼Œè®°å½•-1ï¼Œå‡åˆ°0çš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£é‡Šæ”¾é”



```java
public void add(int m) {
    synchronized(lockA) { // è·å¾—lockAçš„é”
        this.value += m;
        synchronized(lockB) { // è·å¾—lockBçš„é”
            this.another += m;
        } // é‡Šæ”¾lockBçš„é”
    } // é‡Šæ”¾lockAçš„é”
}

public void dec(int m) {
    synchronized(lockB) { // è·å¾—lockBçš„é”
        this.another -= m;
        synchronized(lockA) { // è·å¾—lockAçš„é”
            this.value -= m;
        } // é‡Šæ”¾lockAçš„é”
    } // é‡Šæ”¾lockBçš„é”
}
```

- çº¿ç¨‹1ï¼šè¿›å…¥`add()`ï¼Œè·å¾—`lockA`
- çº¿ç¨‹2ï¼šè¿›å…¥`dec()`ï¼Œè·å¾—`lockB`

- çº¿ç¨‹1ï¼šå‡†å¤‡è·å¾—`lockB`ï¼Œå¤±è´¥ï¼Œç­‰å¾…ä¸­
- çº¿ç¨‹2ï¼šå‡†å¤‡è·å¾—`lockA`ï¼Œå¤±è´¥ï¼Œç­‰å¾…ä¸­

å‡ºç°æ­»é”ï¼šåŒæ–¹æ— é™ç­‰å¾…

*æ­»é”å‘ç”Ÿåï¼Œæ²¡æœ‰ä»»ä½•æœºåˆ¶èƒ½è§£é™¤æ­»é”ï¼Œåªèƒ½å¼ºåˆ¶ç»“æŸJVMè¿›ç¨‹*



**é¿å…æ­»é”**ï¼šçº¿ç¨‹è·å–é”çš„é¡ºåºè¦ä¸€è‡´

```java
public void dec(int m) {
    synchronized(lockA) { // è·å¾—lockAçš„é”
        this.value -= m;
        synchronized(lockB) { // è·å¾—lockBçš„é”
            this.another -= m;
        } // é‡Šæ”¾lockBçš„é”
    } // é‡Šæ”¾lockAçš„é”
}
```



### `wait` å’Œ `notify`

```java
class TaskQueue {
    Queue<String> queue = new LinkedList<>();

    public synchronized void addTask(String s) {
        this.queue.add(s);
    }

    public synchronized String getTask() {
        // è¿™ä¸ªå¾ªç¯æ°¸è¿œä¸ä¼šé€€å‡ºï¼šåœ¨è¿›å…¥ä¹‹å‰è·å–äº†thisé”ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è°ƒç”¨addTask()
        while (queue.isEmpty()) {}
        return queue.remove();
    }
}
```



**å¤šçº¿ç¨‹åè°ƒè¿è¡Œ**çš„åŸåˆ™ï¼šå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼›å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œä»»åŠ¡

```java
...
public synchronized String getTask() {
    while (queue.isEmpty()) {
        /*
        * wait()æ–¹æ³•å¿…é¡»åœ¨å½“å‰è·å–çš„é”å¯¹è±¡ä¸Šè°ƒç”¨ï¼š
        * 	è¿™é‡Œè·å–çš„æ˜¯thisé”ï¼Œå› æ­¤è°ƒç”¨this.wait()
        * å¿…é¡»åœ¨synchronizedå—ä¸­æ‰èƒ½è°ƒç”¨wait()æ–¹æ³•ï¼š
        * 	wait()æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šé‡Šæ”¾çº¿ç¨‹è·å¾—çš„é”ï¼Œwait()æ–¹æ³•è¿”å›æ—¶ï¼Œçº¿ç¨‹åˆä¼šé‡æ–°è¯•å›¾è·å¾—é”
        */
        // é‡Šæ”¾thisé”:
        this.wait();
        // é‡æ–°è·å–thisé”
    }
    return queue.remove();
}
...
    
// --------------------
// while ä¸èƒ½æ¢æˆ if
// 1. Javaçš„wait() å¯èƒ½å‡ºç° è™šå‡å”¤é†’ï¼šçº¿ç¨‹å¯èƒ½åœ¨æ²¡æœ‰è¢«notify()/notifyAll()å”¤é†’çš„æƒ…å†µä¸‹ï¼Œæ— ç¼˜æ— æ•…åœ°ä»ç­‰å¾…çŠ¶æ€æ¢å¤
// 2. å¤šæ¶ˆè´¹è€…ç«äº‰å”¤é†’å¯¼è‡´ä»»åŠ¡è¢«æŠ¢ç©º
```



è¦è®©ç­‰å¾…çš„çº¿ç¨‹è¢«é‡æ–°å”¤é†’ï¼Œç„¶åä»`wait()`æ–¹æ³•è¿”å›ï¼šåœ¨ç›¸åŒçš„é”å¯¹è±¡ä¸Šè°ƒç”¨`notify()`æ–¹æ³•

```java
public synchronized void addTask(String s) {
    this.queue.add(s);
    this.notify(); // å”¤é†’åœ¨thisé”ç­‰å¾…çš„çº¿ç¨‹ï¼ˆæŸä¸€ä¸ªï¼‰
    // notifyAll() å”¤é†’æ‰€æœ‰å½“å‰æ­£åœ¨thisé”ç­‰å¾…çš„çº¿ç¨‹
}
```



### `ReentranLock`

Java 5 å¼•å…¥çš„é«˜çº§çš„å¤„ç†å¹¶å‘çš„`java.util.concurrent`åŒ…ï¼Œå®ƒæä¾›äº†å¤§é‡æ›´é«˜çº§çš„å¹¶å‘åŠŸèƒ½ï¼Œèƒ½å¤§å¤§ç®€åŒ–å¤šçº¿ç¨‹ç¨‹åºçš„ç¼–å†™

`java.util.concurrent.locks`åŒ…æä¾›çš„`ReentrantLock`ç”¨äºæ›¿ä»£`synchronized`åŠ é”

```java
public class Counter {
    private int count;

    public void add(int n) {
        synchronized(this) {
            count += n;
        }
    }
}
/*---ğŸ‘‡---*/
public class Counter {
    private final Lock lock = new ReentrantLock();
    private int count;

    public void add(int n) {
        lock.lock();
        // å°è¯•è·å–é” æœ€å¤šç­‰å¾…1ç§’ï¼Œ1ç§’åæœªå–å¾—é”ï¼ŒtryLock()è¿”å›false
        if (lock.tryLock(1, TimeUnit.SECONDS)) {
            try {
                count += n;
            } finally {
                // éœ€è¦é‡Šæ”¾é”
                lock.unlock();
            }
        }
    }
}
```

`ReentrantLock`æ˜¯å¯é‡å…¥é”



### `Condition`

ä½¿ç”¨`ReentrantLock`æ¯”ç›´æ¥ä½¿ç”¨`synchronized`æ›´å®‰å…¨ï¼Œå¯ä»¥æ›¿ä»£`synchronized`è¿›è¡Œçº¿ç¨‹åŒæ­¥

ä½¿ç”¨`Condition`å¯¹è±¡æ¥å®ç°`synchronized`çš„`wait`å’Œ`notify`çš„åŠŸèƒ½

```java
class TaskQueue {
    private final Lock lock = new ReentrantLock();
    // ä»Lockå®ä¾‹çš„newCondition()è¿”å›Conditionå¯¹è±¡
    private final Condition condition = lock.newCondition();
    private Queue<String> queue = new LinkedList<>();

    public void addTask(String s) {
        lock.lock();
        try {
            queue.add(s);
            condition.signalAll();	// ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
        } finally {
            lock.unlock();
        }
    }

    public String getTask() {
        lock.lock();
        try {
            while (queue.isEmpty()) {
                condition.await();	// ä¼šé‡Šæ”¾å½“å‰é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€
            }
            return queue.remove();
        } finally {
            lock.unlock();
        }
    }
}
```

ç±»ä¼¼`tryLock()`ï¼Œç­‰å¾…æŒ‡å®šæ—¶é—´åï¼Œå¦‚æœè¿˜æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹é€šè¿‡`signal()`æˆ–`signalAll()`å”¤é†’ï¼Œå¯ä»¥è‡ªå·±é†’æ¥

```java
if (condition.await(1, TimeUnit.SECOND)) {
    // è¢«å…¶ä»–çº¿ç¨‹å”¤é†’
} else {
    // æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å”¤é†’
}
```



### `ReadWriteLock`

- åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…¥ï¼ˆå…¶ä»–çº¿ç¨‹æ—¢ä¸èƒ½å†™å…¥ä¹Ÿä¸èƒ½è¯»å–ï¼‰
- æ²¡æœ‰å†™å…¥æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹å…è®¸åŒæ—¶è¯»ï¼ˆæé«˜æ€§èƒ½ï¼‰

```java
public class Counter {
    private final ReadWriteLock rwlock = new ReentrantReadWriteLock();
    // æ³¨æ„: ä¸€å¯¹è¯»é”å’Œå†™é”å¿…é¡»ä»åŒä¸€ä¸ªrwlockè·å–:
    private final Lock rlock = rwlock.readLock();
    private final Lock wlock = rwlock.writeLock();
    private int[] counts = new int[10];
    
    public void inc(int index) {
        wlock.lock(); // åŠ å†™é”
        try {
            counts[index] += 1;
        } finally {
            wlock.unlock(); // é‡Šæ”¾å†™é”
        }
    }

    public int[] get() {
        rlock.lock(); // åŠ è¯»é”
        try {
            return Arrays.copyOf(counts, counts.length);
        } finally {
            rlock.unlock(); // é‡Šæ”¾è¯»é”
        }
    }
}
```
å¤§å¤§æé«˜äº†å¹¶å‘è¯»çš„æ‰§è¡Œæ•ˆç‡

é€‚ç”¨æ¡ä»¶ï¼šåŒä¸€ä¸ªæ•°æ®ï¼Œæœ‰å¤§é‡çº¿ç¨‹è¯»å–ï¼Œä½†ä»…æœ‰å°‘æ•°çº¿ç¨‹ä¿®æ”¹



### `StampedLock`

`ReadWriteLock`å­˜åœ¨é—®é¢˜ï¼šå¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨è¯»ï¼Œå†™çº¿ç¨‹éœ€è¦ç­‰å¾…è¯»çº¿ç¨‹é‡Šæ”¾é”åæ‰èƒ½è·å–å†™é”ï¼Œå³è¯»çš„è¿‡ç¨‹ä¸­ä¸å…è®¸å†™

Java 8å¼•å…¥äº†æ–°çš„è¯»å†™é”ï¼š`StampedLock`

```java
public class Point {
    private final StampedLock stampedLock = new StampedLock();

    private double x;
    private double y;

    public void move(double deltaX, double deltaY) {
        long stamp = stampedLock.writeLock(); // è·å–å†™é”
        try {
            x += deltaX;
            y += deltaY;
        } finally {
            stampedLock.unlockWrite(stamp); // é‡Šæ”¾å†™é”
        }
    }

    public double distanceFromOrigin() {
        long stamp = stampedLock.tryOptimisticRead(); // è·å¾—ä¸€ä¸ªä¹è§‚è¯»é” è¿”å›ç‰ˆæœ¬å·
        // æ³¨æ„ä¸‹é¢ä¸¤è¡Œä»£ç ä¸æ˜¯åŸå­æ“ä½œ
        // å‡è®¾x,y = (100,200)
        double currentX = x;
        // æ­¤å¤„å·²è¯»å–åˆ°x=100ï¼Œä½†x,yå¯èƒ½è¢«å†™çº¿ç¨‹ä¿®æ”¹ä¸º(300,400)
        double currentY = y;
        // æ­¤å¤„å·²è¯»å–åˆ°yï¼Œå¦‚æœæ²¡æœ‰å†™å…¥ï¼Œè¯»å–æ˜¯æ­£ç¡®çš„(100,200)
        // å¦‚æœæœ‰å†™å…¥ï¼Œè¯»å–æ˜¯é”™è¯¯çš„(100,400)
        if (!stampedLock.validate(stamp)) { // validate()éªŒè¯ç‰ˆæœ¬å· æ£€æŸ¥ä¹è§‚è¯»é”åæ˜¯å¦æœ‰å…¶ä»–å†™é”å‘ç”Ÿ
            stamp = stampedLock.readLock(); // è·å–ä¸€ä¸ªæ‚²è§‚è¯»é”
            try {
                currentX = x;
                currentY = y;
            } finally {
                stampedLock.unlockRead(stamp); // é‡Šæ”¾æ‚²è§‚è¯»é”
            }
        }
        return Math.sqrt(currentX * currentX + currentY * currentY);
    }
}
```

`StampedLock`æ˜¯ä¸å¯é‡å…¥é”ï¼Œä¸èƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åå¤è·å–åŒä¸€ä¸ªé”

`StampedLock`è¿˜æä¾›äº†æ›´å¤æ‚çš„å°†æ‚²è§‚è¯»é”å‡çº§ä¸ºå†™é”çš„åŠŸèƒ½ï¼Œå®ƒä¸»è¦ä½¿ç”¨åœ¨if-then-updateçš„åœºæ™¯ï¼šå³å…ˆè¯»ï¼Œå¦‚æœè¯»çš„æ•°æ®æ»¡è¶³æ¡ä»¶ï¼Œå°±è¿”å›ï¼Œå¦‚æœè¯»çš„æ•°æ®ä¸æ»¡è¶³æ¡ä»¶ï¼Œå†å°è¯•å†™



### `Semaphore`

æœ‰æŸç§å—é™èµ„æºï¼Œå®ƒéœ€è¦ä¿è¯åŒä¸€æ—¶åˆ»æœ€å¤šæœ‰Nä¸ªçº¿ç¨‹èƒ½è®¿é—®ï¼Œæ¯”å¦‚åŒä¸€æ—¶åˆ»æœ€å¤šåˆ›å»º100ä¸ªæ•°æ®åº“è¿æ¥ï¼Œæœ€å¤šå…è®¸10ä¸ªç”¨æˆ·ä¸‹è½½ç­‰

```java
public class AccessLimitControl {
    // ä»»æ„æ—¶åˆ»ä»…å…è®¸æœ€å¤š3ä¸ªçº¿ç¨‹è·å–è®¸å¯:
    final Semaphore semaphore = new Semaphore(3);

    public String access() throws Exception {
        // å¦‚æœè¶…è¿‡äº†è®¸å¯æ•°é‡,å…¶ä»–çº¿ç¨‹å°†åœ¨æ­¤ç­‰å¾…:
        semaphore.acquire();
        // å¯ä»¥ä½¿ç”¨tryAcquire(3, TimeUnit.SECONDS)æŒ‡å®šç­‰å¾…æ—¶é—´
        try {
            // TODO:
            return UUID.randomUUID().toString();
        } finally {
            semaphore.release();
        }
    }
}
```

`Semaphore`æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªä¿¡å·è®¡æ•°å™¨ï¼Œç”¨äºé™åˆ¶åŒä¸€æ—¶é—´çš„æœ€å¤§è®¿é—®æ•°é‡



### `Concurrent`é›†åˆ

é’ˆå¯¹`BlockingQueue`, `List`, `Map`, `Set`ç­‰ï¼Œ`java.util.concurrent`åŒ…æä¾›äº†å¯¹åº”çš„å¹¶å‘é›†åˆç±»

| interface | non-thread-safe         | thread-safe                              |
| --------- | ----------------------- | ---------------------------------------- |
| List      | ArrayList               | CopyOnWriteArrayList                     |
| Map       | HashMap                 | ConcurrentHashMap                        |
| Set       | HashSet / TreeSet       | CopyOnWriteArraySet                      |
| Queue     | ArrayDeque / LinkedList | ArrayBlockingQueue / LinkedBlockingQueue |
| Deque     | ArrayDeque / LinkedList | LinkedBlockingDeque                      |

æ‰€æœ‰çš„åŒæ­¥å’ŒåŠ é”çš„é€»è¾‘éƒ½åœ¨é›†åˆå†…éƒ¨å®ç°ï¼Œå¯¹å¤–éƒ¨è°ƒç”¨è€…æ¥è¯´ï¼Œåªéœ€è¦æ­£å¸¸æŒ‰æ¥å£å¼•ç”¨ï¼Œå…¶ä»–ä»£ç å’ŒåŸæ¥çš„éçº¿ç¨‹å®‰å…¨ä»£ç å®Œå…¨ä¸€æ ·

ä½¿ç”¨Javaæ ‡å‡†åº“æä¾›çš„å¹¶å‘é›†åˆï¼Œé¿å…è‡ªå·±ç¼–å†™åŒæ­¥ä»£ç 



### `Atomic`

`java.util.concurrent`åŒ…é™¤äº†æä¾›åº•å±‚é”ã€å¹¶å‘é›†åˆå¤–ï¼Œè¿˜æä¾›äº†ä¸€ç»„åŸå­æ“ä½œçš„å°è£…ç±»:`java.util.concurrent.atomic`



ä»¥`AtomicInteger`ä¸ºä¾‹ï¼Œå®ƒæä¾›çš„ä¸»è¦æ“ä½œæœ‰ï¼š

- å¢åŠ å€¼å¹¶è¿”å›æ–°å€¼ï¼š`int addAndGet(int delta)`
- åŠ 1åè¿”å›æ–°å€¼ï¼š`int incrementAndGet()`
- è·å–å½“å‰å€¼ï¼š`int get()`
- ç”¨CASæ–¹å¼è®¾ç½®ï¼š`int compareAndSet(int expect, int update)`



Atomicç±»æ˜¯é€šè¿‡æ— é”ï¼ˆlock-freeï¼‰çš„æ–¹å¼å®ç°çš„çº¿ç¨‹å®‰å…¨ï¼ˆthread-safeï¼‰è®¿é—®

ä¸»è¦åŸç†æ˜¯åˆ©ç”¨äº†CASï¼šCompare and Set

```java
// é€šè¿‡CASç¼–å†™incrementAndGet()
public int incrementAndGet(AtomicInteger var) {
    int prev, next;
    do {
        prev = var.get();
        next = prev + 1;
    } while ( ! var.compareAndSet(prev, next));
    return next;
}
```

åœ¨è¿™ä¸ªæ“ä½œä¸­ï¼Œå¦‚æœ`AtomicInteger`çš„å½“å‰å€¼æ˜¯`prev`ï¼Œé‚£ä¹ˆå°±æ›´æ–°ä¸º`next`ï¼Œè¿”å›`true`

å¦‚æœ`AtomicInteger`çš„å½“å‰å€¼ä¸æ˜¯`prev`ï¼Œå°±ä»€ä¹ˆä¹Ÿä¸å¹²ï¼Œè¿”å›`false`

é€šè¿‡CASæ“ä½œå¹¶é…åˆ`do ... while`å¾ªç¯ï¼Œå³ä½¿å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†`AtomicInteger`çš„å€¼ï¼Œæœ€ç»ˆçš„ç»“æœä¹Ÿæ˜¯æ­£ç¡®çš„



åœ¨é«˜åº¦ç«äº‰çš„æƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥ä½¿ç”¨Java 8æä¾›çš„`LongAdder`å’Œ`LongAccumulator`



---



# 7  çº¿ç¨‹æ± 

åˆ›å»ºçº¿ç¨‹éœ€è¦æ“ä½œç³»ç»Ÿèµ„æºï¼ˆçº¿ç¨‹èµ„æºï¼Œæ ˆç©ºé—´ç­‰ï¼‰ï¼Œé¢‘ç¹åˆ›å»ºå’Œé”€æ¯å¤§é‡çº¿ç¨‹éœ€è¦æ¶ˆè€—å¤§é‡æ—¶é—´

ä½¿ç”¨xxæ± æ¥å®ç°å¤ç”¨

- çº¿ç¨‹æ± å†…éƒ¨ç»´æŠ¤äº†è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œæ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼Œè¿™äº›çº¿ç¨‹éƒ½å¤„äºç­‰å¾…çŠ¶æ€
- å¦‚æœæœ‰æ–°ä»»åŠ¡ï¼Œå°±åˆ†é…ä¸€ä¸ªç©ºé—²çº¿ç¨‹æ‰§è¡Œ
- å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½å¤„äºå¿™ç¢ŒçŠ¶æ€ï¼Œæ–°ä»»åŠ¡è¦ä¹ˆæ”¾å…¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè¦ä¹ˆå¢åŠ ä¸€ä¸ªæ–°çº¿ç¨‹è¿›è¡Œå¤„ç†



Javaæ ‡å‡†åº“æä¾›äº†ExecutorServiceæ¥å£è¡¨ç¤ºçº¿ç¨‹æ± 

```java
// åˆ›å»ºå›ºå®šå¤§å°çš„çº¿ç¨‹æ± :
ExecutorService executor = Executors.newFixedThreadPool(3);
// æäº¤ä»»åŠ¡:
executor.submit(task1);
executor.submit(task2);
executor.submit(task3);
executor.submit(task4);
executor.submit(task5);
```

Javaæ ‡å‡†åº“æä¾›çš„å‡ ä¸ªå¸¸ç”¨å®ç°ç±»æœ‰ï¼š

- FixedThreadPoolï¼šçº¿ç¨‹æ•°å›ºå®šçš„çº¿ç¨‹æ± ï¼›
- CachedThreadPoolï¼šçº¿ç¨‹æ•°æ ¹æ®ä»»åŠ¡åŠ¨æ€è°ƒæ•´çš„çº¿ç¨‹æ± ï¼›
- SingleThreadExecutorï¼šä»…å•çº¿ç¨‹æ‰§è¡Œçš„çº¿ç¨‹æ± 

åˆ›å»ºè¿™äº›çº¿ç¨‹æ± çš„æ–¹æ³•éƒ½è¢«å°è£…åˆ°`Executors`ç±»ä¸­

```java
// FixedThreadPool
import java.util.concurrent.*;

public class Main {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± :
        ExecutorService es = Executors.newFixedThreadPool(4);
        for (int i = 0; i < 6; i++) {
            es.submit(new Task("" + i));
        }
        // å…³é—­çº¿ç¨‹æ± :
        // ç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å…ˆå®Œæˆï¼Œç„¶åå†å…³é—­
        es.shutdown();
        // shutdownNow() ç«‹åˆ»åœæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
        // awaitTermination() ä¼šç­‰å¾…æŒ‡å®šçš„æ—¶é—´è®©çº¿ç¨‹æ± å…³é—­
    }
}

class Task implements Runnable {
    private final String name;

    public Task(String name) {
        this.name = name;
    }

    @Override
    public void run() {
        System.out.println("start task " + name);
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
        }
        System.out.println("end task " + name);
    }
}

```

```java
// CachedThreadPool
// çº¿ç¨‹æ± çš„å¤§å°é™åˆ¶åœ¨4ï½10ä¸ªä¹‹é—´åŠ¨æ€è°ƒæ•´
int min = 4;
int max = 10;
ExecutorService es = new ThreadPoolExecutor(
        min, max,
        60L, TimeUnit.SECONDS,
        new SynchronousQueue<Runnable>());
```

```java
// ScheduledThreadPool
// ä»»åŠ¡ï¼Œéœ€è¦å®šæœŸåå¤æ‰§è¡Œï¼Œä¾‹å¦‚ï¼Œæ¯ç§’åˆ·æ–°è¯åˆ¸ä»·æ ¼ã€‚è¿™ç§ä»»åŠ¡æœ¬èº«å›ºå®šï¼Œéœ€è¦åå¤æ‰§è¡Œçš„ï¼Œå¯ä»¥ä½¿ç”¨ScheduledThreadPool
// æ”¾å…¥ScheduledThreadPoolçš„ä»»åŠ¡å¯ä»¥å®šæœŸåå¤æ‰§è¡Œ
ScheduledExecutorService ses = Executors.newScheduledThreadPool(4);
// 1ç§’åæ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡:
ses.schedule(new Task("one-time"), 1, TimeUnit.SECONDS);
// 2ç§’åå¼€å§‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œæ¯3ç§’æ‰§è¡Œ:
ses.scheduleAtFixedRate(new Task("fixed-rate"), 2, 3, TimeUnit.SECONDS);
// 2ç§’åå¼€å§‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œä»¥3ç§’ä¸ºé—´éš”æ‰§è¡Œ:
ses.scheduleWithFixedDelay(new Task("fixed-delay"), 2, 3, TimeUnit.SECONDS);

åœ¨FixedRateæ¨¡å¼ä¸‹ï¼Œå‡è®¾æ¯ç§’è§¦å‘ï¼Œå¦‚æœæŸæ¬¡ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡1ç§’ï¼Œåç»­ä»»åŠ¡ ä¸ä¼šå¹¶å‘æ‰§è¡Œï¼Œä¼šã€Œå»¶è¿Ÿæ‰§è¡Œã€ï¼Œä¸”åç»­å‘¨æœŸä¼šä»¥ã€Œä»»åŠ¡ç»“æŸæ—¶é—´ã€ä¸ºåŸºå‡†é‡æ–°è®¡ç®—
    
å¦‚æœä»»åŠ¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œåç»­ä»»åŠ¡ ä¸ä¼šç»§ç»­æ‰§è¡Œï¼Œè¯¥å®šæ—¶ä»»åŠ¡ä¼šè¢«æ°¸ä¹…å–æ¶ˆï¼Œçº¿ç¨‹æ± ä¸å†è°ƒåº¦è¯¥ä»»åŠ¡
```



---



# 8 **`Future`**

`ExecutorService.submit()`æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª`Future`ç±»å‹

`Future`ç±»å‹çš„å®ä¾‹ä»£è¡¨ä¸€ä¸ªæœªæ¥èƒ½è·å–ç»“æœçš„å¯¹è±¡

```java
ExecutorService executor = Executors.newFixedThreadPool(4); 
// å®šä¹‰ä»»åŠ¡:
Callable<String> task = new Task();
// æäº¤ä»»åŠ¡å¹¶è·å¾—Future:
Future<String> future = executor.submit(task);
// ä»Futureè·å–å¼‚æ­¥æ‰§è¡Œè¿”å›çš„ç»“æœ:
String result = future.get(); // å¼‚æ­¥ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œé˜»å¡ ç›´åˆ°ä»»åŠ¡å®Œæˆåæ‰è¿”å›ç»“æœ
```



ä¸€ä¸ª`Future<V>`æ¥å£è¡¨ç¤ºä¸€ä¸ªæœªæ¥å¯èƒ½ä¼šè¿”å›çš„ç»“æœï¼Œå®ƒå®šä¹‰çš„æ–¹æ³•æœ‰ï¼š

- `get()`ï¼šè·å–ç»“æœï¼ˆå¯èƒ½ä¼šç­‰å¾…ï¼‰
- `get(long timeout, TimeUnit unit)`ï¼šè·å–ç»“æœï¼Œä½†åªç­‰å¾…æŒ‡å®šçš„æ—¶é—´ï¼›
- `cancel(boolean mayInterruptIfRunning)`ï¼šå–æ¶ˆå½“å‰ä»»åŠ¡ï¼›
- `isDone()`ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²å®Œæˆã€‚



---





# 9 **`CompletableFuture`**

ä½¿ç”¨`Future`è·å¾—å¼‚æ­¥æ‰§è¡Œç»“æœæ—¶ï¼Œå¯èƒ½å‡ºç°é˜»å¡ï¼Œä¸»çº¿ç¨‹è¢«è¿«ç­‰å¾…

Java 8å¼€å§‹å¼•å…¥äº†`CompletableFuture`ï¼Œå¯ä»¥ä¼ å…¥å›è°ƒå¯¹è±¡ï¼Œå½“å¼‚æ­¥ä»»åŠ¡å®Œæˆæˆ–è€…å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨å›è°ƒå¯¹è±¡çš„å›è°ƒæ–¹æ³•

```java
// CompletableFuture
import java.util.concurrent.CompletableFuture;

public class Main {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºå¼‚æ­¥æ‰§è¡Œä»»åŠ¡:
        // CompletableFuture.supplyAsync() éœ€è¦ä¸€ä¸ªå®ç°äº†Supplieræ¥å£çš„å¯¹è±¡
        // Main.fetchPrice()é™æ€æ–¹æ³•çš„ç­¾åç¬¦åˆSupplieræ¥å£çš„å®šä¹‰
        CompletableFuture<Double> cf = CompletableFuture.supplyAsync(Main::fetchPrice);
        // å¦‚æœæ‰§è¡ŒæˆåŠŸ:
        // è°ƒç”¨Consumerå¯¹è±¡
        cf.thenAccept((result) -> {
            System.out.println("price: " + result);
        });
        // å¦‚æœæ‰§è¡Œå¼‚å¸¸:
        // è°ƒç”¨Functionå¯¹è±¡
        cf.exceptionally((e) -> {
            e.printStackTrace();
            return null;
        });
        // ä¸»çº¿ç¨‹ä¸è¦ç«‹åˆ»ç»“æŸï¼Œå¦åˆ™CompletableFutureé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ± ä¼šç«‹åˆ»å…³é—­:
        Thread.sleep(200);
    }

    static Double fetchPrice() {
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
        }
        if (Math.random() < 0.3) {
            throw new RuntimeException("fetch price failed!");
        }
        return 5 + Math.random() * 20;
    }
}
```

`CompletableFuture`çš„ä¼˜ç‚¹æ˜¯ï¼š

- å¼‚æ­¥ä»»åŠ¡ç»“æŸæ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•

- å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶ï¼Œä¼šè‡ªåŠ¨å›è°ƒæŸä¸ªå¯¹è±¡çš„æ–¹æ³•

- ä¸»çº¿ç¨‹è®¾ç½®å¥½å›è°ƒåï¼Œä¸å†å…³å¿ƒå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œ

- å¤šä¸ª`CompletableFuture`å¯ä»¥

  - ä¸²è¡Œæ‰§è¡Œï¼š

    ```java
    CompletableFuture<T> query1 = CompletableFuture.supplyAsync(xxx);
    CompletableFuture<V> query2 = query1.thenApplyAsync(xxx);
    query2.thenAccept(xxx);
    ```

  - å¹¶è¡Œæ‰§è¡Œï¼š

    ```java
    CompletableFuture<T> query1 = CompletableFuture.supplyAsync(xxx);
    CompletableFuture<V> query2 = CompletableFuture.supplyAsync(xxx);
    // ç”¨anyOfåˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„CompletableFuture: allOf() åªè¦ä¸€ä¸ªæˆåŠŸ
    // allOf() éƒ½å¿…é¡»æˆåŠŸ
    CompletableFuture<Object> query3 = CompletableFuture.anyOf(query1, query2);
    ...
    ```



---



# 10 **`ForkJoin`**

Java 7å¼€å§‹å¼•å…¥äº†ä¸€ç§æ–°çš„Fork/Joinçº¿ç¨‹æ± ï¼Œå®ƒå¯ä»¥æ‰§è¡Œä¸€ç§ç‰¹æ®Šçš„ä»»åŠ¡ï¼šæŠŠä¸€ä¸ªå¤§ä»»åŠ¡æ‹†æˆå¤šä¸ªå°ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ

ä½¿ç”¨Fork/Joinå¯¹å¤§æ•°æ®è¿›è¡Œå¹¶è¡Œæ±‚å’Œï¼š

```java
import java.util.Random;
import java.util.concurrent.*;

public class Main {
    public static void main(String[] args) throws Exception {
        // åˆ›å»º2000ä¸ªéšæœºæ•°ç»„æˆçš„æ•°ç»„:
        long[] array = new long[2000];
        long expectedSum = 0;
        for (int i = 0; i < array.length; i++) {
            array[i] = random();
            expectedSum += array[i];
        }
        System.out.println("Expected sum: " + expectedSum);
        // fork/join:
        ForkJoinTask<Long> task = new SumTask(array, 0, array.length);
        long startTime = System.currentTimeMillis();
        Long result = ForkJoinPool.commonPool().invoke(task);
        long endTime = System.currentTimeMillis();
        System.out.println("Fork/join sum: " + result + " in " + (endTime - startTime) + " ms.");
    }

    static Random random = new Random(0);

    static long random() {
        return random.nextInt(10000);
    }
}

class SumTask extends RecursiveTask<Long> {
    static final int THRESHOLD = 500;
    long[] array;
    int start;
    int end;

    SumTask(long[] array, int start, int end) {
        this.array = array;
        this.start = start;
        this.end = end;
    }

    // ç»§æ‰¿è‡ªRecursiveTask
    @Override
    protected Long compute() {
        if (end - start <= THRESHOLD) {
            // å¦‚æœä»»åŠ¡è¶³å¤Ÿå°,ç›´æ¥è®¡ç®—:
            long sum = 0;
            for (int i = start; i < end; i++) {
                sum += this.array[i];
                // æ•…æ„æ”¾æ…¢è®¡ç®—é€Ÿåº¦:
                try {
                    Thread.sleep(1);
                } catch (InterruptedException e) {
                }
            }
            return sum;
        }
        // ä»»åŠ¡å¤ªå¤§,ä¸€åˆ†ä¸ºäºŒ:
        int middle = (end + start) / 2;
        System.out.println(String.format("split %d~%d ==> %d~%d, %d~%d", start, end, start, middle, middle, end));
        SumTask subtask1 = new SumTask(this.array, start, middle);
        SumTask subtask2 = new SumTask(this.array, middle, end);
        invokeAll(subtask1, subtask2);
        Long subresult1 = subtask1.join();
        Long subresult2 = subtask2.join();
        Long result = subresult1 + subresult2;
        System.out.println("result = " + subresult1 + " + " + subresult2 + " ==> " + result);
        return result;
    }
}
```

Javaæ ‡å‡†åº“æä¾›çš„`java.util.Arrays.parallelSort(array)`å¯ä»¥è¿›è¡Œå¹¶è¡Œæ’åºï¼Œå®ƒçš„åŸç†å°±æ˜¯å†…éƒ¨é€šè¿‡Fork/Joinå¯¹å¤§æ•°ç»„åˆ†æ‹†è¿›è¡Œå¹¶è¡Œæ’åºï¼Œåœ¨å¤šæ ¸CPUä¸Šå°±å¯ä»¥å¤§å¤§æé«˜æ’åºçš„é€Ÿåº¦



---



# 11 **`ThreadLocal`**

å¤šçº¿ç¨‹æ˜¯Javaå®ç°å¤šä»»åŠ¡çš„åŸºç¡€ï¼Œ`Thread`å¯¹è±¡ä»£è¡¨ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­è°ƒç”¨`Thread.currentThread()`è·å–å½“å‰çº¿ç¨‹

å¯¹äºå¤šä»»åŠ¡ï¼ŒJavaæ ‡å‡†åº“æä¾›çš„çº¿ç¨‹æ± å¯ä»¥æ–¹ä¾¿åœ°æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼ŒåŒæ—¶å¤ç”¨çº¿ç¨‹

Webåº”ç”¨ç¨‹åºå°±æ˜¯å…¸å‹çš„å¤šä»»åŠ¡åº”ç”¨ï¼Œæ¯ä¸ªç”¨æˆ·è¯·æ±‚é¡µé¢æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šåˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œç±»ä¼¼

```java
public void process(User user) {
    checkPermission();
    doWork(user);
    saveStatus();
    sendResponse();
}
```

ç„¶åï¼Œé€šè¿‡çº¿ç¨‹æ± å»æ‰§è¡Œè¿™äº›ä»»åŠ¡

`process()`æ–¹æ³•éœ€è¦ä¼ é€’`User`å®ä¾‹ï¼Œä½†æ˜¯å¾€å¾€ä¸€ä¸ªæ–¹æ³•åˆä¼šè°ƒç”¨å…¶ä»–å¾ˆå¤šæ–¹æ³•ï¼Œè¿™æ ·ä¼šå¯¼è‡´`User`ä¼ é€’åˆ°æ‰€æœ‰åœ°æ–¹



è¿™ç§åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ¨ªè·¨è‹¥å¹²æ–¹æ³•è°ƒç”¨ï¼Œéœ€è¦ä¼ é€’çš„å¯¹è±¡ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸ºä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ï¼Œå®ƒæ˜¯ä¸€ç§çŠ¶æ€ï¼Œå¯ä»¥æ˜¯ç”¨æˆ·èº«ä»½ã€ä»»åŠ¡ä¿¡æ¯ç­‰

ç»™æ¯ä¸ªæ–¹æ³•å¢åŠ ä¸€ä¸ªcontextå‚æ•°éå¸¸éº»çƒ¦ï¼Œä¸”è‹¥è°ƒç”¨é“¾æœ‰ç¬¬ä¸‰æ–¹åº“ï¼Œåˆ™æœ‰å¯èƒ½æ— æ³•ä¼ é€’





Javaæ ‡å‡†åº“æä¾›çš„`ThreadLocal`ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä¼ é€’åŒä¸€ä¸ªå¯¹è±¡

```java
static ThreadLocal<User> threadLocalUser = new ThreadLocal<>();
```

```java
void processUser(user) {
    try {
        // è®¾ç½®ä¸€ä¸ªUserå®ä¾‹å…³è”åˆ°ThreadLocalä¸­ï¼Œåœ¨ç§»é™¤ä¹‹å‰ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥éšæ—¶è·å–åˆ°è¯¥Userå®ä¾‹
        threadLocalUser.set(user);
        step1();
        step2();
        log();
    } finally {
        // æ¸…é™¤
        threadLocalUser.remove();
    }
}

// æ™®é€šçš„æ–¹æ³•è°ƒç”¨ä¸€å®šæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ threadLocalUser.get()è·å–çš„Userå¯¹è±¡æ˜¯åŒä¸€ä¸ªå®ä¾‹
// å¯ä»¥æŠŠThreadLocalçœ‹æˆä¸€ä¸ªå…¨å±€Map<Thread, Object>ï¼šæ¯ä¸ªçº¿ç¨‹è·å–ThreadLocalå˜é‡æ—¶ï¼Œæ€»æ˜¯ä½¿ç”¨Threadè‡ªèº«ä½œä¸ºkey
void step1() {
    User u = threadLocalUser.get();
    log();
    printUser();
}
...
```



å¯ä»¥ä¸€ä¸ªä¿å­˜äº†å½“å‰ç”¨æˆ·çš„`ThreadLocal`å¯ä»¥å°è£…ä¸ºä¸€ä¸ª`UserContext`å¯¹è±¡

```java
// å®ç° AutoCloseable ç„¶å é€šè¿‡ try (resource) {...} è®©ç¼–è¯‘å™¨è‡ªåŠ¨å…³é—­
public class UserContext implements AutoCloseable {

    static final ThreadLocal<String> ctx = new ThreadLocal<>();

    public UserContext(String user) {
        ctx.set(user);
    }

    public static String currentUser() {
        return ctx.get();
    }

    @Override
    public void close() {
        ctx.remove();
    }
}
```



```
 â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
|  Thread
|  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
| |  ThreadLocalMap
| |  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
| | |
| | |
```



---



# 12 è™šæ‹Ÿçº¿ç¨‹

Java 19å¼•å…¥çš„ä¸€ç§è½»é‡çº§çº¿ç¨‹ï¼Œåœ¨å¾ˆå¤šå…¶ä»–è¯­è¨€ä¸­è¢«ç§°ä¸ºåç¨‹ã€çº¤ç¨‹ã€ç»¿è‰²çº¿ç¨‹ã€ç”¨æˆ·æ€çº¿ç¨‹ç­‰

çº¿ç¨‹çš„ç‰¹ç‚¹ï¼š

- çº¿ç¨‹æ˜¯ç”±æ“ä½œç³»ç»Ÿåˆ›å»ºå¹¶è°ƒåº¦çš„èµ„æº
- çº¿ç¨‹åˆ‡æ¢ä¼šè€—è´¹å¤§é‡CPUæ—¶é—´
- ä¸€ä¸ªç³»ç»Ÿèƒ½åŒæ—¶è°ƒåº¦çš„çº¿ç¨‹æ•°é‡æ˜¯æœ‰é™çš„ï¼Œé€šå¸¸åœ¨å‡ ç™¾è‡³å‡ åƒçº§åˆ«



IOå¯†é›†å‹ä»»åŠ¡ï¼šéœ€è¦å¤„ç†å¤§é‡IOè¯·æ±‚ï¼Œä¸€æ—¦è¯»å†™IOï¼Œçº¿ç¨‹å°±å¿…é¡»è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°IOæ•°æ®è¿”å›

IOæ“ä½œåŒ…æ‹¬ï¼šè¯»å†™æ–‡ä»¶ã€è¯»å†™ç½‘ç»œï¼ˆä¾‹å¦‚HTTPè¯·æ±‚ï¼‰ã€è¯»å†™æ•°æ®åº“ï¼ˆæœ¬è´¨æ˜¯é€šè¿‡JDBCå®ç°ç½‘ç»œè°ƒç”¨ï¼‰

å¤„ç†IOæ“ä½œçš„çº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…IOï¼ŒçœŸæ­£ç”±CPUæ‰§è¡Œçš„ä»£ç æ¶ˆè€—çš„æ—¶é—´éå¸¸å°‘



å¼•å…¥**è™šæ‹Ÿçº¿ç¨‹**ï¼šé«˜æ•ˆæ‰§è¡ŒIOå¯†é›†å‹ä»»åŠ¡

è™šæ‹Ÿçº¿ç¨‹ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œè€Œæ˜¯ç”±æ™®é€šçº¿ç¨‹è°ƒåº¦ï¼Œå³æˆç™¾ä¸Šåƒä¸ªè™šæ‹Ÿçº¿ç¨‹å¯ä»¥ç”±ä¸€ä¸ªæ™®é€šçº¿ç¨‹è°ƒåº¦

1. ä»»ä½•æ—¶åˆ»ï¼Œåªèƒ½æ‰§è¡Œä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œ

2. ä¸€æ—¦è¯¥è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œä¸€ä¸ªIOæ“ä½œè¿›å…¥ç­‰å¾…æ—¶ï¼Œå®ƒä¼šè¢«ç«‹åˆ»â€œæŒ‚èµ·â€ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹

3. IOæ•°æ®è¿”å›ï¼ŒæŒ‚èµ·çš„è™šæ‹Ÿçº¿ç¨‹è¢«å†æ¬¡è°ƒåº¦

ç”±æ­¤ï¼Œè‹¥å¹²ä¸ªè™šæ‹Ÿçº¿ç¨‹å¯ä»¥åœ¨ä¸€ä¸ªæ™®é€šçº¿ç¨‹ä¸­äº¤æ›¿è¿è¡Œ



```java
// 1. ç›´æ¥åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹å¹¶è¿è¡Œ
// ä¼ å…¥Runnableå®ä¾‹å¹¶ç«‹åˆ»è¿è¡Œ:
Thread vt = Thread.startVirtualThread(() -> {
    System.out.println("Start virtual thread...");
    Thread.sleep(10);
    System.out.println("End virtual thread.");
});

// 2. åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ä½†ä¸è‡ªåŠ¨è¿è¡Œï¼Œè€Œæ˜¯æ‰‹åŠ¨è°ƒç”¨start()
Thread vt = Thread.ofVirtual().unstarted(() -> {
    System.out.println("Start virtual thread...");
    Thread.sleep(1000);
    System.out.println("End virtual thread.");
});
vt.start();

// 3. é€šè¿‡è™šæ‹Ÿçº¿ç¨‹çš„ThreadFactoryåˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨start()
ThreadFactory tf = Thread.ofVirtual().factory();
// åˆ›å»ºVirtualThread:
Thread vt = tf.newThread(() -> {
    System.out.println("Start virtual thread...");
    Thread.sleep(1000);
    System.out.println("End virtual thread.");
});
vt.start();
```

ç›´æ¥è°ƒç”¨`start()`å®é™…ä¸Šæ˜¯ç”±`ForkJoinPool`çš„çº¿ç¨‹æ¥è°ƒåº¦çš„

```java
// è‡ªå·±åˆ›å»ºè°ƒåº¦å™¨
ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();
// åˆ›å»ºå¤§é‡è™šæ‹Ÿçº¿ç¨‹å¹¶è°ƒåº¦:
ThreadFactory tf = Thread.ofVirtual().factory();
for (int i=0; i<100000; i++) {
    Thread vt = tf.newThread(() -> { ... });
    executor.submit(vt);
    // ä¹Ÿå¯ä»¥ç›´æ¥ä¼ å…¥Runnableæˆ–Callable:
    executor.submit(() -> {
        System.out.println("Start virtual thread...");
        Thread.sleep(1000);
        System.out.println("End virtual thread.");
        return true;
    });
}
```



è™šæ‹Ÿçº¿ç¨‹å±äºéå¸¸è½»é‡çº§çš„èµ„æºï¼Œéšç”¨éšåˆ›ï¼Œç”¨å®Œå³ä»ï¼Œä¸éœ€è¦æ± åŒ–



**é™åˆ¶**ï¼š

åªæœ‰ä»¥è™šæ‹Ÿçº¿ç¨‹æ–¹å¼è¿è¡Œçš„ä»£ç ï¼Œæ‰ä¼šåœ¨æ‰§è¡ŒIOæ“ä½œæ—¶è‡ªåŠ¨è¢«æŒ‚èµ·å¹¶åˆ‡æ¢åˆ°å…¶ä»–è™šæ‹Ÿçº¿ç¨‹

å¯ä»¥è‡ªåŠ¨å¼•å‘è°ƒåº¦åˆ‡æ¢çš„æ“ä½œåŒ…æ‹¬ï¼š

- æ–‡ä»¶IO
- ç½‘ç»œIO
- ä½¿ç”¨Concurrentåº“å¼•å‘ç­‰å¾…
- Thread.sleep()æ“ä½œ

åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­ï¼Œå¦‚æœç»•è¿‡JDKçš„IOæ¥å£ï¼Œç›´æ¥é€šè¿‡JNIè¯»å†™æ–‡ä»¶æˆ–ç½‘ç»œæ˜¯æ— æ³•å®ç°è°ƒåº¦çš„ã€‚æ­¤å¤–ï¼Œåœ¨`synchronized`å—å†…éƒ¨ä¹Ÿæ— æ³•è°ƒåº¦